# 文本生成

### preprocess

在生成字典的时候发现了部分文字由于编码问题缺失，故作以下修正：

花门kO面请雪耻 -> 花门剺面请雪耻

苞枿ba矣 -> 苞枿薱矣

翠微zc叶垂鬓唇 -> 翠微盍叶垂鬓唇

权门多噂eR -> 权门多噂沓

屈rH猛 -> 屈赟猛

时唱接z5歌 -> 时唱接篱歌 



### char-level-rnn

直接将每个汉字看做一个字符，将问题当做char-level的rnn生成来处理



在生成过程中采用类似$\epsilon - greedy$的思想：



以$\epsilon$的概率随机生成，以$1 - \epsilon$的概率依据softmax层的得分按照加权后的概率生成



最后随机取10个字作为第一个字符生成长为300的串



### result

在不同参数下的结果中取出一个case作为代表进行分析



- epochs-100   hidden-size-256  dropout-0.5  epsilon 0.0

  > Case #笛:
  > 笛，击鼍鼓，皓齿歌，细腰舞。
  > 况是青春日将暮，桃花乱落如红雨。劝君终日酩酊醉，
  > 酒不到刘伶坟上土。
  >
  > 君马黄，我马白，马色虽不同，人心本无隔。
  > 共作游冶盘，双行洛阳陌。长剑既照曜，高冠何赩赫。
  > 各有千金裘，俱为五侯客。猛虎落陷阱，壮夫时屈厄。
  > 相知在急难，独好亦何益。
  >
  > 何地早芳菲，宛在长门殿。夭桃色若绶，秾李光如练。
  > 啼鸟弄花疏，游蜂饮香遍。叹息春风起，飘零君不见。
  >
  > 芳树本多奇，年华复在斯。结翠成新幄，开红满旧枝。
  > 风归花历乱，日度影参差。容色朝朝落，思君君不知。
  >
  > 玉花珍簟上，金缕画屏开。晓月怜筝柱，春风忆镜台。
  > 筝柱春风吹晓月，芳树落花朝暝歇。稿砧刀头未有时，
  > 攀条拭泪坐相思。
  >
  > 迢迢芳



生成的文本就是原文本37行起的某一个连续片段，所以说模型overfit了



- epochs-100   hidden-size-128  dropout-0.5  epsilon 0.0

  > Case #冰:
  > 冰底水，千里江南楼。江山。威武辉耀，
  > 乘清氛。赫炎溥畅，融大钧。
  >
  > 苞枿薱矣，惟根之蟠。弥巴蔽荆，负南极以安。
  > 曰我旧梁氏，辑绥艰难。江汉之阻，都邑固以完。
  > 圣人作，神武用，有臣勇智，奋不以众。投迹死地，
  > 谋猷纵。化敌为家，虑则中。浩浩海裔，不威而同。
  > 系缧降王，定厥功。澶漫万里，宣唐风。蛮夷九译，
  > 咸来从。凯旋金奏，象形容。震赫万国，罔不龚。
  >
  > 河右澶漫，顽为之魁。王师如雷震，昆仑以颓。
  > 上聋下聪，骜不可回。助仇抗有德，惟人之灾。
  > 乃溃乃奋，执缚归厥命。万室蒙其仁，一夫则病。
  > 濡以鸿泽，皇之圣。威畏德怀，功以定。顺之于理，
  > 物咸遂厥性。
  >
  > 铁山碎，大漠舒。二虏劲，连穹庐。背北海，专坤隅。
  > 岁来

首先“冰底水，”是原文第457的原句“浮生却似冰底水，日夜东流人不知。”。

但是“千里江南楼”就没有在原文里出现过了，原文中只分别在不同的地方出现过“千里”、“江南”、“楼”。

接下来“威武辉耀”是原文193段“威武辉耀，明鬼区。” 的子串，有趣的是接下来的是175行的中的一段“羲和显耀，乘清氛。赫炎溥畅，融大钧。”的后部分，不知道将“明鬼区”替换为“乘清氛”是巧合，还是RNN学到了后面应当接上一个3字的短句。

后面3段都是原文了，可能模型还是overfit了

- epochs-100   hidden-size-128  dropout-0.4  epsilon 0.0

  > Case #乱:
  > 乱，一书先生起，飘飖委墀柳。
  >
  > 吾闻青嶂合，山树绕谷开。 
  >
  > 童儿汲井华，离思不可攀，离思不可攀。侧塞被径花，飘飖委墀柳。
  > 艰难世事迫，隐遁佳期后。晤语契深心，观风吹无敌，庶往空鞍香。
  >
  > 吾来青丝传，风吹青丝履，分
  > 既夷击。 
  >
  > 细腰青井华，小子空望游。
  >
  > 童儿汲井华，离思不可攀，离思不可攀。侧塞被径花，飘飖委墀柳。
  > 艰难世事迫，隐遁佳期后。晤语契深心，观风吹无敌，庶往空鞍香。
  >
  > 吾来青丝传，风吹青丝履，分
  > 既夷击。 
  >
  > 细腰青井华，小子空望游。
  >
  > 童儿汲井华，离思不可攀，离思不可攀。侧塞被径花，飘飖委墀柳。
  > 艰难世事迫，隐遁佳期后。晤语契深心，观风吹无敌，庶往空鞍香。
  >
  > 吾来青丝传，风吹青丝履
  >



出现大段循环，看loss分析应该是underfit。



- epochs-150   hidden-size-128  dropout-0.4  epsilon 0.0

  > Case #耳:
  > 耳黍穗黑，农夫田妇无消息。
  > 城中斗米换衾裯，相许宁论两相直。
  > 闻君终南山，各在长安魂。
  > 先生有道汉家。
  > 焉知饿死填沟壑。相如逸才亲涤器，子云识字终投阁。
  > 即事壮重险，论功超五丁。坡陀因厚地，千村万里谁。江城佐股肱。高斋征学问，虚薄滥先登。
  > 尝读远公传，惟人心断绝。文章应解伴牢愁。
  > 水接西江山岳深，岂待同病亦知文。
  >
  > 芳树已寥落，孤英尤可嘉。可怜团团叶，盖覆深深花。
  > 阴崖常抱雪，枯涧为生多，青石摧林丘。
  > 中夜窟宅改，移因风雨秋。访旧半为鬼，高歌有冻死。
  > 大臣拜手，惟称之谟。
  >
  > 琉璃钟，琥珀浓，小槽酒滴真珠红。烹龙炮凤玉脂泣，
  > 罗屏绣幕围香风。吹龙笛，击鼍鼓，皓齿歌，细腰舞。
  > 况资菱芡足，庶结茅茨迥

跳过直接重复原文的部分

“闻君终南山，各在长安魂。”，“闻君”、“终南山”、“各在”、“长安”、“魂”各作为互不连续出现的片段，可以说“终”与“魂”的搭配从语义上来说还是可以接受的。

再来看看“尝读远公传，惟人心断绝。文章应解伴牢愁。水接西江山岳深，岂待同病亦知文。”一段。

“尝读远公传”是原文299行“尝读远公传，永怀尘外踪。”的原句，

"惟人心断绝"则是由"惟人"和“心断绝”拼接而成，

"文章应解伴牢愁"是原文404行“梦寐几回迷蛱蝶，文章应解伴牢愁。”的原句，

"水接西江山岳深"是由“水接西江天外声”与"山岳"、“深”组合而成，

"岂待同病亦知文"由“岂待”、“同病亦同忧”、“知文”三个部分组合而成，而且最后的“文”在某种意义上还与前文的“传”、“文章”呼应。这一段还是由那么些意思在里面的。

- epochs-150   hidden-size-128  dropout-0.45  epsilon 0.0

  > Case #陇:
  > 陇野花。坐听听国活。喧喧斗鸡道，行歌激越梢
  > 鸣环反复无秋经。
  > 当今廊庙具，构厦岂云缺。葵藿倾太阳，物华固难船。
  >
  > 人生有所思，暮亦有所思。驱车还复天，列筵秩宴北。
  > 山公子面苍，春别终南风。来头白日月，开怀旧业楼。
  >
  > 人生有谢氏，冠带理，城中遇知己。不可久未已，奔流鸣。深怒鷇麛，抗乔岳。
  > 翘萌牙，傲霜雹。王谋内定，申掌握。铺施芟夷，
  > 咸人心。威吾宁假楫，挂席自生风。
  > 所思碍行潦，九里信不通。
  >
  > 今年流泉绿，动如参与商。今夕未已尘，何时如云间。
  >
  > 细软青丝履，光明不肯敛。天阴对图画，最觉润龙鳞。
  > 灯影照无睡，心清闻妙香。夜深殿突兀，风动金锒铛。
  > 天黑闭春院，地清栖暗芳。玉绳回断绝，铁凤森翱翔。
  > 梵放

“喧喧斗鸡道，行歌激越梢”由"喧喧斗鸡道，行乐羡朋从。" 与“长歌激越梢林莽” 合成得到的，意外的还不错。

"人生有所思，暮亦有所思。"由"人生有情泪沾臆"与“朝亦有所思，暮亦有所思”融合而得。

"驱车还复天"由“驱车还向东”与"复"、"天"合成。

“列筵秩宴北”由“列筵邀酒伴”、"筵秩宴北林"得到。

- epochs-150   hidden-size-128  dropout-0.45  epsilon 0.3

  > Case #绝:
  > 绝，巢岐饮渭
  > 白尤青吹问，不复见。
  > 风日远吞空煮
  > 。吾枫绎，猜钩每梵今。厥性。智勇伏贫米辨登眺左儒奏谁衔杯。搏触年，空传夏倦葱，髻授苏。坐华筵席，
  > 风动汀忧渴投亭念嘉。
  > 猛虎蜜陷空阳霞。
  >
  > 守臣不任，勩于神圣局惟王。故诀调本竹朗然羁墙虽云何，只今何处觅藏具。
  > 诉天僭地谁摇此昆仑。
  > 预出羲光荒，尾嵲终积敦烹羊宰，拙闻奈辙绽。扫除似无刷。
  > 君不杂鸳舟，阴知在桃色著阙，瑚钩，掇歌。
  > 宴自有神，霆树坠高飞瑟。
  >
  >
  > 雪霆夹虚蹋。陵麦散海，
  >
  > 雄阜颜将进。
  > 秋人有代谢，往因恣覆垂寓金。
  > 兹别不无同，家日辚，空使君不随。骑
  > 水毒晚春院脑赠姿背柄何其窟。席人滨拾自生象飞白，烟沮漳东室。
  > 芳树持浦覆，铁舅氏，诸翁

由于随机输出的存在，诗歌的格式被打乱了，故考虑遇到非汉字则不进行$\epsilon-greedy$操作

下面是修改后的结果：

> Case #诛:
> 诛内踯，曾冰杀营眠。
>
> 雨秋滩萧诵，惠多瓶，何柱琥时浴，
> 英尤可热，但来。
> 灯影照耸换，青鸟飞似。
> 水接青臆，春风。雨味如沃，
> 手麟矣待，青贵不可怜。驴千金翮，青山白昼下。 
>
> 柯亭杯云迥，只今不可怜。醉歌衍湖无。
>
> 童儿汲井华，输愿亦易求。 
>
> 吾道昧澒换，春风礼新声啾。
>
> 童惊衡湿天，除，入门空。凌晨望，物
> 各在堆大浅。万里云黑枫，促豁不胸网此处。
> 切磨在馨心。深
> 长安置酒鸳，独立落花中授通，藤冰寒具鸡。乘陵霿，规敦室。
> 琴史旷野理，且为之北侯。
>
> 吾道昧神适，速门不讴起。沾洒不堪摘。明日萧条秋。明日昭阳远，哀丝不可求。苏晋长滋，遁觉，若使崒门。百杯捶犁辞。
> 豁人浴作长安。
> 捷鼓眉留天加下峰	

可以看出还是比较乱的，可能这种方法不太适合用于文本生成上吧。

- epochs-200   hidden-size-128  dropout-0.45  epsilon 0.3

  > Case #凤:
  > 凤凰楼。霜楼中霿日，遥处图皇行。天生跨鞍迥，有漏固
  > 挥。
  > 沿洄洲渚趣，演漾钩歌音。
  > 默经四海，，听尘催。
  >
  > 聋枯竞缭，千衢阴峥嵘，蜜笔如一心。
  > 珍首霹混合，擘别惰山，充安缚川海。
  >
  > 握中戚里稷，失业徒。
  > 默思失业徒，因送别登何。
  > 方逢鼻凛天土无，萤钓玉襞眠。君菲终极处先生，一饮，池塘百岁空。
  > 水殿半倾事人，啖侯笔不停。粲可逾陂，枝务拥笑。麻嶓功，虞舜，
  > 往往坡陀纵超越。角壮翻同麋鹿游，浮深簸荡鼋谬窟。
  > 泉任喷薄涨冬，惟萍来躬耕。
  > 黪饥鹰，袖翻绮栊。
  > 耳衣已予亦，秦凌袴飞醉。
  > 库才花散，鸿鹄去不报，夜梅飘飖委雀深。群澒洞人已卒，栖栖吴楚间。
  > 吟理有道性，推桔饥夸楚，宾。坡陀金虾蟆，出见报不威。
  > 答

特意把参数往overfit的方向调了下，不过看似改变有限。

- epochs-150   hidden-size-128  dropout-0.45  epsilon 0.1

  > Case #元:
  > 元气。
  >
  > 天子呼苍天，排风松肃泠。黄门之翮开，足之追冥搜。仰穿龙遮晚，兽之落。
  >
  > 淹留欢娱，舒光杂蛙黾。
  > 知君看稷与郑。
  > 诸孙贫无聊，宠。 
  >
  > 奉室陪其仁，辍弹。府中难甘见，未停。与宴息相思，焉能心。 
  >
  > 奉辞还杖陈，王师亦有神，
  > 永安架引舒，永怀尘渌襟。
  >
  > 童霄落，羞忍耻是渥洼生，汗血今称献于此。苑中騋牝三千匹，
  > 豪华真有秋，惯捷瓶上手。沾洒不濡地，扫除似无帚。
  > 明烽暖雁日远，擘舟杂锋镝。知。
  >
  > 东甍何嗟及掣阴。背若万里，
  > 别来青鸟东流。
  > 风吹高台，九桓江山起，熊螭回不径。明朝在太阴。献于此时出，泥污后土无时，
  > 此意远淑且难，
  > 永安壮儿不复知，
  > 护海一饭，烟雾搴高牖。侧塞被径花，飘飖委墀柳。

"天子呼苍天，排风松肃泠。"由“天子呼来不上船”、"苍天"、“会是排风有毛质”、“风松肃泠泠”四句合成

"奉辞还杖陈，王师亦有神"由“奉辞还杖策”、“陈”、“王师”、“虽未成龙亦有神”四段合成，虽然内容可能没什么意义，但是“陈”和“神”的尾韵还是不错的，虽然可能多半是巧合。



### 小结

合适的参数还是能够使得RNN学到一定的诗歌的结构的，同时能够对不同的片段进行拼接组合，生成一些看似大体合理的句子的。

对于在文本生成时怎样利用softmax层的输出来生成下一个字符是还需要改进的地方。简单的$\epsilon - greedy$策略在这里似乎并不好用。